{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Collaborative Document - {{ room.name }}</title>
    <link rel="stylesheet" href="{% static 'css/document.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
        .cursor-indicator {
            position: absolute;
            width: 2px;
            height: 20px;
            background: red;
            animation: blink 1s step-start 0s infinite;
            z-index: 999;
        }

        .user-label {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 999;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        #editor {
            position: relative;
        }
    </style>
</head>
<body>

<div id="editing-users">No one is editing...</div>

<div class="container">
    <h1>Room: {{ room.name }}</h1>
    <p>Start editing the document below:</p>

    <div id="active-users" class="user-badge-container"></div>

    <div class="toolbar">
        <button type="button" onclick="formatText('bold')"><b>B</b></button>
        <button type="button" onclick="formatText('italic')"><i>I</i></button>
        <button type="button" onclick="formatText('underline')"><u>U</u></button>
        <button onclick="document.execCommand('undo', false, null)">Undo</button>
        <button onclick="document.execCommand('redo', false, null)">Redo</button>
        <button onclick="manualSave()">Save</button>
    </div>

    <div id="editor" contenteditable="true"></div>
</div>

<script>
    let roomId = "{{ room.id }}";
    let username = "{{ request.user.username }}";
    let editor = document.getElementById("editor");
    let lastContent = "";
    let cursors = {};

    let socketProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    let socket = new WebSocket(`${socketProtocol}://${window.location.host}/ws/document/${roomId}/`);

    function getCaretPosition() {
        let selection = window.getSelection();
        if (selection.rangeCount === 0) return null;
        let range = selection.getRangeAt(0);
        return {
            offset: range.startOffset,
            path: getPath(range.startContainer)
        };
    }

    function getPath(node) {
        let path = [];
        while (node && node !== editor) {
            let index = Array.from(node.parentNode.childNodes).indexOf(node);
            path.unshift(index);
            node = node.parentNode;
        }
        return path;
    }

    function getNodeByPath(path) {
        let node = editor;
        for (let i of path) {
            node = node.childNodes[i];
        }
        return node;
    }

    function insertCursor(username, caret) {
        if (!caret || !caret.path) return;
        let node = getNodeByPath(caret.path);
        if (!node) return;

        let range = document.createRange();
        let offset = Math.min(caret.offset, node.length || 0);
        range.setStart(node, offset);
        range.collapse(true);

        let rect = range.getBoundingClientRect();
        let editorRect = editor.getBoundingClientRect();

        let cursorId = `cursor-${username}`;
        let labelId = `label-${username}`;

        removeCursor(username); // Remove old

        let cursor = document.createElement("div");
        cursor.id = cursorId;
        cursor.className = "cursor-indicator";
        cursor.style.left = `${rect.left - editorRect.left}px`;
        cursor.style.top = `${rect.top - editorRect.top}px`;

        let label = document.createElement("div");
        label.id = labelId;
        label.className = "user-label";
        label.textContent = username;
        label.style.left = `${rect.left - editorRect.left + 5}px`;
        label.style.top = `${rect.top - editorRect.top - 20}px`;

        editor.appendChild(cursor);
        editor.appendChild(label);
    }

    function removeCursor(username) {
        let oldCursor = document.getElementById(`cursor-${username}`);
        let oldLabel = document.getElementById(`label-${username}`);
        if (oldCursor) oldCursor.remove();
        if (oldLabel) oldLabel.remove();
    }

    function sendUpdate() {
        let content = editor.innerHTML;
        let caret = getCaretPosition();

        socket.send(JSON.stringify({
            type: "update",
            content: content,
            username: username,
            caret: caret
        }));

        lastContent = content;
    }

    editor.addEventListener("input", () => {
        sendUpdate();
    });

    document.addEventListener("selectionchange", () => {
        sendUpdate();
    });

    socket.onopen = () => {
        loadContent();
        setInterval(saveContent, 3000);
        editor.focus();
    };

    socket.onmessage = (event) => {
        let data = JSON.parse(event.data);

        if (data.type === "document_update") {
            if (data.content !== lastContent) {
                editor.innerHTML = data.content;
                lastContent = data.content;
                hljs.highlightAll();
            }
        }

        if (data.type === "cursor_update" && data.username !== username) {
            insertCursor(data.username, data.caret);
        }
    };

    function loadContent() {
        fetch(`/get-document/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.content !== lastContent) {
                    editor.innerHTML = data.content;
                    lastContent = data.content;
                    hljs.highlightAll();
                }
            });
    }

    function formatText(command) {
        document.execCommand(command, false, null);
        editor.focus();
    }

    function manualSave() {
        fetch(`/save-document/${roomId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ content: editor.innerHTML })
        }).then(() => {
            alert("Document saved manually!");
        });
    }

    function saveContent() {
        fetch(`/save-document/${roomId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ content: editor.innerHTML })
        });
    }

    function updateActiveUsers() {
        fetch(`/get-active-users/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById("active-users");
                container.innerHTML = '';
                data.users.forEach(user => {
                    const span = document.createElement("span");
                    span.className = "user-badge";
                    span.textContent = user;
                    container.appendChild(span);
                });
            });
    }

    function updateEditingStatus() {
        fetch(`/update-editing-status/${roomId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
    }

    function fetchEditingUsers() {
        fetch(`/get-editing-users/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                const usersDiv = document.getElementById("editing-users");
                if (data.editing.length > 0) {
                    usersDiv.innerText = "Editing: " + data.editing.join(", ");
                } else {
                    usersDiv.innerText = "No one is editing...";
                }
            });
    }

    editor.addEventListener("input", updateEditingStatus);
    setInterval(fetchEditingUsers, 5000);
    setInterval(updateActiveUsers, 5000);
</script>
</body>
</html>
